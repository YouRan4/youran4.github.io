name: Cleanup Old Workflow Runs

on:
  schedule:
    # 每周一早上 00:00 UTC 运行
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const days_to_keep = 7; // 保留 7 天内的运行记录
            
            // 获取所有工作流
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo,
              per_page: 100
            });
            
            let total_deleted = 0;
            
            for (const workflow of workflows.data.workflows) {
              console.log(`\n处理工作流: ${workflow.name} (ID: ${workflow.id})`);
              
              try {
                // 获取该工作流的所有运行
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner,
                  repo,
                  workflow_id: workflow.id,
                  per_page: 100
                });
                
                const now = new Date();
                let deleted_count = 0;
                
                for (const run of runs.data.workflow_runs) {
                  const created_at = new Date(run.created_at);
                  const age_days = (now - created_at) / (1000 * 60 * 60 * 24);
                  
                  if (age_days > days_to_keep) {
                    try {
                      await github.rest.actions.deleteWorkflowRun({
                        owner,
                        repo,
                        run_id: run.id
                      });
                      console.log(`  ✓ 删除运行 ${run.id} (年龄: ${age_days.toFixed(1)} 天)`);
                      deleted_count++;
                    } catch (error) {
                      console.log(`  ✗ 无法删除运行 ${run.id}: ${error.message}`);
                    }
                  }
                }
                
                if (deleted_count > 0) {
                  console.log(`  共删除 ${deleted_count} 条运行记录`);
                } else {
                  console.log(`  没有符合条件的记录需要删除`);
                }
                total_deleted += deleted_count;
              } catch (error) {
                console.log(`  ✗ 处理工作流时出错: ${error.message}`);
              }
            }
            
            console.log(`\n========== 总计删除 ${total_deleted} 条运行记录 ==========`);
